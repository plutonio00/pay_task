# Тестовое задание.

**Условие**:
Используя любой PHP-фреймворк создать приложение, которое имеет следующие
возможности: любой пользователь приложения может выбрать любого другого пользователя
приложения (кроме себя), чтобы сделать отложенный перевод денежных средств со своего
счета на счет выбранного пользователя. При планировании такого перевода пользователь
указывает сумму перевода в рублях, дату и время, когда нужно произвести перевод. Сумма
перевода ограничена балансом клиента на момент планирования перевода с учетом ранее
запланированных и невыполненных его исходящих переводов. Дата и время выбирается с
точностью до часа с использованием календаря. Способ выбора пользователя - любой (можно
просто ввод ID). Ввод данных должен валидироваться как на стороне клиента, так и на стороне
сервера с выводом ошибок пользователю.
Показать на сайте список всех пользователей и информацию об их одном последнем
переводе с помощью одного SQL-запроса к БД.
Реализовать сам процесс выполнения запланированных переводов. Не допустить
ситуации, при которой у какого-либо пользователя окажется отрицательный баланс.
Написанный для решения задачи код не должен содержать уязвимостей. Процесс
регистрации и проверки прав доступа можно не реализовывать. Для этого допустимо добавить
дополнительное поле ввода для указания текущего пользователя. Внешний вид страниц
значения не имеет.
Решение задачи должно содержать:
1. Весь текст поставленного тестового задания.
2. Четкую инструкцию по развертыванию проекта с целью работоспособности. Приветствуется использование Docker.
3. Миграции и сиды для наполнения БД демонстрационными данными.

## Описание проекта.
**Общая информация.**
Я решил усложнить условие задачи, и добавил следующие моменты:
1. Сделать авторизацию/регистрацию.
2. У каждого пользователя может быть несколько счетов.
3. Можно переводить деньги с одного своего счета на другой свой счет (при этом нельзя переводить деньги на один и тот же счет).
4. Счета можно создавать и пополнять.
5. Переводы можно отменять или (в случае если ранее перевод не прошел) повторять.

**Функционал**:
* авторизация/регистрация
* показ профиля пользователя
* создание счетов и их пополнение
* создание переводов, возможность их отмены или повторного запуска в случае если до этого перевод не прошел
* отложенное выполнение переводов
* страница со статистикой - список всех пользователей с информацией об их последнем переводе. Т.к. в задаче не было конкретизировано какой
  перевод имеется ввиду, то отображаю информацию о последнем выполненном переводе.

**Стек**: docker, PHP7.4, Yii2, MySQL, nginx, jQuery, HTML, CSS, Bootstrap.

**Страницы проекта**: информация по страницам проекта находится [здесь](https://github.com/plutonio00/pay_task/blob/master/docs/ru/pages.md)

## Особенности реализации.
### Frontend
Для JS в фронте использован jQuery. Так как в проекте был сделан упор на backend, то сборки фронта в проекте нет.
### Разграничение прав пользователей.
Для разграничения прав пользователей используется RBAC. В прокте есть две RBAC роли - user (доступ к личному кабинету) и admin (помимо доступов юзера также имеет доступ к модулю admin и соответственно, к странице со статистикой).
### Профиль пользователя.
В профиле пользователя можно посмотреть информацию о его счетах и переводах.
### Счета пользователя.
У счетов есть id и title. Title счетов должен быть уникален в пределах одного пользователя (т.е. все счета одного пользователя должны иметь разные названия, при этом у другого пользователя могут быть счета с такими же названиями), это будет учтено при валидации во время создания новых счетов. На счетах может быть сумма, представляющая собой десятичную дробь с двумя знаками после запятой, до запятой может быть маскимум 11 знаков.
### Переводы.
* **создание переводов**: при создании переводов валидируется рядом условий:
    * счета с указанными id должны быть в базе;
    * счет должен принадлежать пользователю;
    * нельзя переводить деньги с одного счета на тот же самый счет;
    * будет проверена возможность осуществления перевода конкретной суммы с учетом ранее запланированных, но не выполненных переводов. При этом в ошибке будет указано какой получается баланс если выполнить этот перевод;
    * будет проверен формат времени перевода, а так же что указанное время не ранее текущего;
* **список переводов**: отображается в таблице, при этом если пользователь является владельцем счета, то будет отображено его название, иначе только id счета.
* **отложенное выполнение переводов**: осуществляется с помощью cron-задачи и консольной команды для Yii2. Сама команда выполняется каждый час согласно условию задачи. Команда выполняется следующим образом:
    * сначала будет проверено, не запущен ли уже такой процесс. Таким образом можно избежать ситуации, когда команда по каким-то причинам работает больше часа и в это же время будет запущен второй процесс, а потом возможно третий и т.д.;
    * далее будут выбраны все переводы в статусе in progress, и с временем выполнения ранее чем текущее. Такой выбор времени выполнения (а не за последний час) обусловлен тем, что в случае если команда работала несколько часов, например с 15 до 19 часов, а переводы выбраны за прошедший час, до переводы с 15 до 17 часов не будут выполнены);
    * непосредственно переводы осуществляются с помощью транзакций;
    * после выполнения всех переводов выполняется запрос для страницы со статистикой переводов (описана в разделе "Функционал"), и далее результат этого выполнения записывается в кэш.
### Страница статистики переводов.
Для статистики переводов создан отдельный модуль с названием admin. При загрузке страницы данные будут взять либо из кэша, либо (в случае в кэше данных нет) из базы. 